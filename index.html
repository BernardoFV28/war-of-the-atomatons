<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>War of the Automatons: Protocolo Biomassa</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            margin: 0;
            background-color: #000;
            overflow: hidden;
            font-family: 'Share Tech Mono', monospace;
            user-select: none;
        }

        /* HUD / UI */
        #hud-container {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            pointer-events: none;
            color: #00ffff;
        }

        .stat-card {
            background: rgba(0, 5, 15, 0.85);
            border: 1px solid #00ffff;
            padding: 10px 15px;
            margin-bottom: 8px;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
            min-width: 180px;
        }

        #xp-bar-main {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: #111;
            z-index: 20;
        }

        #xp-bar-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ffd700, #ff8800);
            box-shadow: 0 0 15px #ffd700;
            transition: width 0.3s ease;
        }

        /* MENUS */
        .overlay-menu {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            color: #fff;
            backdrop-filter: blur(10px);
        }

        .upgrade-grid {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .upgrade-card {
            width: 220px;
            padding: 25px;
            border: 2px solid #00ffff;
            background: #000d1a;
            cursor: pointer;
            text-align: center;
            transition: 0.3s;
        }

        .upgrade-card:hover {
            background: #00ffff;
            color: #000;
            transform: translateY(-10px);
            box-shadow: 0 0 30px #00ffff;
        }

        #biome-announcement {
            position: absolute;
            top: 30%;
            width: 100%;
            text-align: center;
            font-size: 3rem;
            color: #ff0055;
            text-shadow: 0 0 20px #ff0055;
            pointer-events: none;
            opacity: 0;
            z-index: 50;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="xp-bar-main"><div id="xp-bar-fill"></div></div>

    <div id="hud-container">
        <div class="stat-card">SETOR: <span id="val-biome" style="color:#ffd700">Dungeon</span></div>
        <div class="stat-card">WAVE: <span id="val-wave">1</span></div>
        <div class="stat-card">KILLS: <span id="val-kills">0</span></div>
        <div class="stat-card">HP: <span id="val-hp">100/100</span></div>
    </div>

    <div id="biome-announcement">ANOMALIA DETECTADA</div>

    <div id="levelup-menu" class="overlay-menu">
        <h1 style="color:#00ffff; letter-spacing: 10px;">LEVEL UP</h1>
        <div id="upgrade-list" class="upgrade-grid"></div>
    </div>

    <div id="gameover-menu" class="overlay-menu">
        <h1 style="color:#ff0044;">SISTEMA OFFLINE</h1>
        <button onclick="location.reload()" style="background:none; border: 1px solid #fff; color:#fff; padding:15px 30px; cursor:pointer; font-family:inherit;">REINICIAR</button>
    </div>

    <script>
        // --- CONFIGURAÇÃO DE ATIVOS (ASSETS) ---
        const ASSETS = {
            player: 'assets/player.png',
            enemy: 'assets/enemy_robot.png',
            enemyFast: 'assets/enemy_fast.png',
            enemyTank: 'assets/enemy_tank.png',
            boss: 'assets/boss_robot.png',
            bullet: 'assets/bullet.png',
            xp: 'assets/ammo.png',
            // Biomas
            bg_dungeon: 'assets/dungeon_floor.png',
            bg_cryo: 'assets/bg_cryo.png',
            bg_glitch: 'assets/bg_glitch.png',
            bg_neon: 'assets/bg_neon.png',
            bg_cathedral: 'assets/bg_cathedral.png'
        };

        class MainScene extends Phaser.Scene {
            constructor() {
                super('MainScene');
                this.kills = 0;
                this.wave = 1;
                this.isPaused = false;
                this.currentBiomeKey = 'bg_dungeon';
            }

            preload() {
                // Carregar ativos
                Object.entries(ASSETS).forEach(([key, path]) => {
                    this.load.image(key, path);
                });

                // Sistema de Fallback (Caso as imagens não existam na pasta assets)
                this.load.on('loaderror', (file) => {
                    let color = 0x00ffff;
                    if(file.key.includes('enemy')) color = 0xff0000;
                    if(file.key.includes('bg')) color = 0x111111;
                    if(file.key === 'bullet') color = 0xffff00;
                    
                    const graphics = this.make.graphics({x: 0, y: 0, add: false});
                    graphics.fillStyle(color, 1);
                    graphics.fillRect(0, 0, 64, 64);
                    graphics.generateTexture(file.key, 64, 64);
                });
            }

            create() {
                // Configuração do Mundo
                const worldSize = 4000;
                this.physics.world.setBounds(0, 0, worldSize, worldSize);
                
                // Inicialização do Bioma (Fundo)
                this.bg = this.add.tileSprite(0, 0, worldSize, worldSize, 'bg_dungeon').setOrigin(0);

                // Player
                this.player = this.physics.add.sprite(worldSize/2, worldSize/2, 'player');
                this.player = this.physics.add.sprite(x, y, 'player');
                this.player.setScale(0.4);
                this.player.stats = {
                    hp: 100, maxHp: 100,
                    speed: 250, dmg: 30,
                    xp: 0, nextXp: 100,
                    lvl: 1
                };
                this.player.setCollideWorldBounds(true);
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);

                // Grupos
                this.enemies = this.physics.add.group();
                this.bullets = this.physics.add.group();
                this.xpDrops = this.physics.add.group();

                // Teclado
                this.keys = this.input.keyboard.addKeys('W,A,S,D');

                // Colisões
                this.physics.add.overlap(this.bullets, this.enemies, this.hitEnemy, null, this);
                this.physics.add.collider(this.player, this.enemies, this.hitPlayer, null, this);
                this.physics.add.overlap(this.player, this.xpDrops, this.collectXp, null, this);

                // Loops de Tempo
                this.time.addEvent({ delay: 500, callback: this.autoShoot, loop: true, callbackScope: this });
                this.time.addEvent({ delay: 1000, callback: this.spawnEnemies, loop: true, callbackScope: this });

                this.updateUI();
            }

            update() {
                if (this.isPaused) return;

                // Movimentação
                let vx = 0, vy = 0;
                if (this.keys.W.isDown) vy = -1;
                if (this.keys.S.isDown) vy = 1;
                if (this.keys.A.isDown) vx = -1;
                if (this.keys.D.isDown) vx = 1;

                const vel = new Phaser.Math.Vector2(vx, vy).normalize().scale(this.player.stats.speed);
                this.player.setVelocity(vel.x, vel.y);

                // Gerenciamento de Biomas Dinâmicos
                this.manageBiomes();

                // IA Inimigos
                this.enemies.getChildren().forEach(en => {
                    if (en.active) this.physics.moveToObject(en, this.player, en.speed || 100);
                });
            }

            // --- LÓGICA DE BIOMAS ---
            manageBiomes() {
                let nextKey = 'bg_dungeon';
                let name = "Nexus: Dungeon";

                // Verificação de condições solicitadas
                if (this.wave >= 15) {
                    nextKey = 'bg_cathedral';
                    name = "Catedral Silício (Final)";
                } else if (this.kills >= 500) {
                    nextKey = 'bg_neon';
                    name = "º`distorção+`´";
                } else if (this.wave >= 10) {
                    nextKey = 'bg_glitch';
                    name = "Vazio do Código";
                } else if (this.wave >= 5) {
                    nextKey = 'bg_cryo';
                    name = "Setor Criogénico";
                }

                // Troca de bioma apenas se for diferente do atual
                if (this.currentBiomeKey !== nextKey) {
                    this.currentBiomeKey = nextKey;
                    this.bg.setTexture(nextKey);
                    
                    // Feedback Visual de Troca
                    this.cameras.main.flash(1000, 0, 255, 255);
                    this.announceBiome(name);
                    document.getElementById('val-biome').innerText = name;
                }
            }

            announceBiome(name) {
                const el = document.getElementById('biome-announcement');
                el.innerText = `SETOR: ${name.toUpperCase()}`;
                el.style.opacity = '1';
                this.time.delayedCall(3000, () => { el.style.opacity = '0'; });
            }

            // --- COMBATE & SISTEMAS ---
            autoShoot() {
                const target = this.physics.closest(this.player, this.enemies.getChildren());
                if (!target || this.isPaused) return;

                const b = this.bullets.create(this.player.x, this.player.y, 'bullet');
                if(b) {
                    b.setTint(0x00ffff);
                    this.physics.moveToObject(b, target, 600);
                    b.dmg = this.player.stats.dmg;
                    this.time.delayedCall(2000, () => b.destroy());
                }
            }

            spawnEnemies() {
                if (this.enemies.countActive() > 60 || this.isPaused) return;

                const angle = Math.random() * Math.PI * 2;
                const dist = 700;
                const sx = this.player.x + Math.cos(angle) * dist;
                const sy = this.player.y + Math.sin(angle) * dist;

                let type = 'enemy';
                let hp = 50 + (this.wave * 10);
                let speed = 120;

                if (this.wave > 7 && Math.random() > 0.7) { type = 'enemyFast'; speed = 220; hp *= 0.6; }
                if (this.wave > 12 && Math.random() > 0.8) { type = 'enemyTank'; speed = 70; hp *= 3; }

                const en = this.enemies.create(sx, sy, type);
                en.hp = hp;
                en.speed = speed;
            }

            spawnBoss() {
                const boss = this.enemies.create(this.player.x, this.player.y - 400, 'boss');
                boss.setScale(2.5);
                boss.hp = 2000 * (this.wave / 5);
                boss.speed = 90;
                boss.isBoss = true;
            }

            hitEnemy(bullet, enemy) {
                bullet.destroy();
                enemy.hp -= bullet.dmg;
                enemy.setTint(0xff0000);
                this.time.delayedCall(100, () => { if(enemy.active) enemy.clearTint(); });

                if (enemy.hp <= 0) {
                    this.kills++;
                    // Drop XP
                    const xp = this.xpDrops.create(enemy.x, enemy.y, 'xp');
                    xp.val = enemy.isBoss ? 500 : 25;
                    
                    enemy.destroy();
                    this.updateUI();

                    // Progressão de Wave
                    if (this.kills % 25 === 0) {
                        this.wave++;
                        if (this.wave % 5 === 0) this.spawnBoss();
                        this.updateUI();
                    }
                }
            }

            hitPlayer(player, enemy) {
                player.stats.hp -= 0.1;
                this.updateUI();
                if (player.stats.hp <= 0) this.gameOver();
            }

            collectXp(player, xp) {
                player.stats.xp += xp.val;
                xp.destroy();
                if (player.stats.xp >= player.stats.nextXp) this.showLevelUp();
                this.updateUI();
            }

            // --- UI & MENUS ---
            updateUI() {
                document.getElementById('val-kills').innerText = this.kills;
                document.getElementById('val-wave').innerText = this.wave;
                document.getElementById('val-hp').innerText = `${Math.floor(this.player.stats.hp)}/${this.player.stats.maxHp}`;
                
                const xpPerc = (this.player.stats.xp / this.player.stats.nextXp) * 100;
                document.getElementById('xp-bar-fill').style.width = `${xpPerc}%`;
            }

            showLevelUp() {
                this.isPaused = true;
                this.physics.pause();
                this.player.stats.lvl++;
                this.player.stats.xp = 0;
                this.player.stats.nextXp *= 1.4;

                const menu = document.getElementById('levelup-menu');
                const list = document.getElementById('upgrade-list');
                menu.style.display = 'flex';
                list.innerHTML = '';

                const upgs = [
                    { t: 'NÚCLEO DE POTÊNCIA', d: '+20% Dano', f: () => this.player.stats.dmg += 15 },
                    { t: 'SERVOS DE ALTA VELOCIDADE', d: '+15% Movimento', f: () => this.player.stats.speed += 40 },
                    { t: 'REPARO INTEGRAL', d: 'Cura & +50 Max HP', f: () => { this.player.stats.maxHp += 50; this.player.stats.hp = this.player.stats.maxHp; } }
                ];

                upgs.forEach(u => {
                    const card = document.createElement('div');
                    card.className = 'upgrade-card';
                    card.innerHTML = `<h3>${u.t}</h3><p>${u.d}</p>`;
                    card.onclick = () => {
                        u.f();
                        menu.style.display = 'none';
                        this.isPaused = false;
                        this.physics.resume();
                    };
                    list.appendChild(card);
                });
            }

            gameOver() {
                this.isPaused = true;
                this.physics.pause();
                document.getElementById('gameover-menu').style.display = 'flex';
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            physics: { default: 'arcade', arcade: { debug: false } },
            scene: MainScene
        };

        const game = new Phaser.Game(config);

        window.addEventListener('resize', () => {
            game.scale.resize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>


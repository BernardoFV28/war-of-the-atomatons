<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Robot Survivors: Protocolo Glitch</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #00d2ff; font-family: 'Courier New', monospace; user-select: none; }
        canvas { display: block; image-rendering: pixelated; }
        
        /* UI */
        #ui-layer { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 10; }
        .stat { background: rgba(0, 10, 30, 0.8); padding: 10px; border: 1px solid #00d2ff; margin-bottom: 5px; box-shadow: 0 0 10px #00d2ff55; }
        
        #xp-bar-container { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: #111; z-index: 20; }
        #xp-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00d2ff, #00ff88); transition: width 0.2s; }

        #biome-announcement { 
            position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%);
            font-size: 3rem; font-weight: bold; text-transform: uppercase;
            text-shadow: 0 0 20px #00d2ff; opacity: 0; transition: 1.5s; pointer-events: none;
            z-index: 50; text-align: center;
        }

        /* Menu de Upgrades */
        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; display: none; }
        #card-container { display: flex; gap: 20px; }
        .card { 
            width: 200px; background: #050505; border: 2px solid #00d2ff; 
            border-radius: 10px; padding: 15px; cursor: pointer; transition: 0.3s;
            text-align: center;
        }
        .card:hover { transform: scale(1.05); background: #001a33; }
        .card h3 { color: #fff; font-size: 1rem; }
        .card p { color: #888; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>

    <div id="ui-layer">
        <div class="stat">BIOMA: <span id="biome-name">Depósito</span></div>
        <div class="stat">HP: <span id="hp-count">100</span></div>
        <div class="stat">KILLS: <span id="kill-count">0</span></div>
        <div class="stat">SP (PONTOS): <span id="sp-count">0</span></div>
    </div>

    <div id="biome-announcement">SETOR ATUALIZADO</div>

    <div id="overlay">
        <h1 style="color: #fff;">ESCOLHA UM UPGRADE</h1>
        <div id="card-container"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- ASSETS ---
const assets = {
    player: new Image(), enemy: new Image(),
    bg_scrapyard: new Image(), bg_neon: new Image(),
    bg_cryo: new Image(), bg_cathedral: new Image(), bg_glitch: new Image()
};
assets.player.src = 'assets/player.png';
assets.enemy.src = 'assets/enemy_robot.png';
assets.bg_scrapyard.src = 'assets/bg_scrapyard.png';
assets.bg_neon.src = 'assets/bg_neon.png';
assets.bg_cryo.src = 'assets/bg_cryo.png';
assets.bg_cathedral.src = 'assets/bg_cathedral.png';
assets.bg_glitch.src = 'assets/bg_glitch.png';

// --- CONFIGURAÇÃO DE BIOMAS ---
const biomes = {
    scrapyard: { name: "Depósito de Sucata", img: assets.bg_scrapyard, speedMod: 1, friction: 0.15 },
    neon: { name: "Rede Neon", img: assets.bg_neon, speedMod: 1.4, friction: 0.1 },
    cryo: { name: "Setor Criogénico", img: assets.bg_cryo, speedMod: 0.9, friction: 0.02 },
    cathedral: { name: "Catedral Silicon", img: assets.bg_cathedral, speedMod: 1, friction: 0.15 },
    glitch: { name: "Vazio do Código", img: assets.bg_glitch, speedMod: 1.2, friction: 0.08 }
};

// --- ESTADO DO JOGO ---
const game = {
    timer: 0,
    kills: 0,
    paused: false,
    currentBiome: biomes.scrapyard,
    enemies: [],
    bullets: [],
    upgrades: [
        { id: 'dmg', name: 'Canhão Pesado', desc: '+10 Dano' },
        { id: 'ms', name: 'Multi-Tiro', desc: '+1 Bala' },
        { id: 'hp', name: 'Reparo', desc: 'Recupera Vida' }
    ]
};

const player = {
    x: window.innerWidth/2, y: window.innerHeight/2,
    vx: 0, vy: 0, hp: 100, maxHp: 100,
    speed: 5, level: 1, xp: 0, nextXp: 100, sp: 0,
    dmg: 20, fr: 25, cd: 0, ms: 1, iFrames: 0
};

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

// --- FUNÇÕES AUXILIARES ---
function drawImg(img, x, y, size, fallback) {
    if(img.complete && img.naturalWidth !== 0) {
        ctx.drawImage(img, x - size/2, y - size/2, size, size);
    } else {
        ctx.fillStyle = fallback;
        ctx.fillRect(x - size/2, y - size/2, size, size);
        ctx.strokeStyle = "white"; ctx.strokeRect(x - size/2, y - size/2, size, size);
    }
}

function announce(text) {
    const el = document.getElementById('biome-announcement');
    el.innerText = text; el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, 2000);
}

// --- LÓGICA DE UPGRADES ---
function showUpgradeMenu() {
    game.paused = true;
    document.getElementById('overlay').style.display = 'flex';
    const container = document.getElementById('card-container');
    container.innerHTML = '';
    
    game.upgrades.forEach(upg => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `<h3>${upg.name}</h3><p>${upg.desc}</p>`;
        div.onclick = () => {
            if(upg.id === 'dmg') player.dmg += 10;
            if(upg.id === 'ms') player.ms++;
            if(upg.id === 'hp') player.hp = player.maxHp;
            
            document.getElementById('overlay').style.display = 'none';
            game.paused = false;
            requestAnimationFrame(loop);
        };
        container.appendChild(div);
    });
}

// --- LOOP PRINCIPAL ---
function loop() {
    if (game.paused) return;

    game.timer++;
    
    // 1. Atualizar Bioma (a cada 1 min)
    if(game.timer % 3600 === 0) {
        if(game.timer < 3600*2) game.currentBiome = biomes.neon;
        else if(game.timer < 3600*3) game.currentBiome = biomes.cryo;
        else game.currentBiome = biomes.glitch;
        announce(game.currentBiome.name);
        document.getElementById('biome-name').innerText = game.currentBiome.name;
    }

    // 2. Desenhar Fundo
    if(game.currentBiome.img.complete) {
        const pattern = ctx.createPattern(game.currentBiome.img, 'repeat');
        ctx.fillStyle = pattern; ctx.fillRect(0,0,canvas.width, canvas.height);
    } else {
        ctx.fillStyle = "#111"; ctx.fillRect(0,0,canvas.width, canvas.height);
    }

    // 3. Movimento Player (com física de Bioma)
    let ax = 0, ay = 0;
    if(keys['w']) ay = -1; if(keys['s']) ay = 1;
    if(keys['a']) ax = -1; if(keys['d']) ax = 1;

    player.vx += ax * 0.8; player.vy += ay * 0.8;
    player.vx *= (1 - game.currentBiome.friction);
    player.vy *= (1 - game.currentBiome.friction);
    player.x += player.vx * game.currentBiome.speedMod;
    player.y += player.vy * game.currentBiome.speedMod;
    
    if(player.iFrames > 0) player.iFrames--;
    drawImg(assets.player, player.x, player.y, 45, '#00d2ff');

    // 4. Inimigos (Spawn Corrigido)
    if(Math.random() < 0.03 && game.enemies.length < 40) {
        const side = Math.floor(Math.random()*4);
        let ex, ey;
        if(side==0){ ex=Math.random()*canvas.width; ey=-50; }
        else if(side==1){ ex=canvas.width+50; ey=Math.random()*canvas.height; }
        else if(side==2){ ex=Math.random()*canvas.width; ey=canvas.height+50; }
        else { ex=-50; ey=Math.random()*canvas.height; }
        game.enemies.push({ x: ex, y: ey, hp: 30 + (player.level*10) });
    }

    game.enemies.forEach((en, i) => {
        const ang = Math.atan2(player.y - en.y, player.x - en.x);
        en.x += Math.cos(ang) * 2; en.y += Math.sin(ang) * 2;
        drawImg(assets.enemy, en.x, en.y, 35, 'red');

        // Colisão Player
        if(Math.hypot(player.x-en.x, player.y-en.y) < 30 && player.iFrames <= 0) {
            player.hp -= 0.2;
            if(player.hp <= 0) location.reload();
        }
    });

    // 5. Tiro Automático
    if(player.cd > 0) player.cd--;
    if(player.cd <= 0 && game.enemies.length > 0) {
        const target = game.enemies[0];
        const ang = Math.atan2(target.y - player.y, target.x - player.x);
        for(let i=0; i<player.ms; i++) {
            game.bullets.push({ 
                x: player.x, y: player.y, 
                vx: Math.cos(ang + (i*0.1)) * 10, vy: Math.sin(ang + (i*0.1)) * 10 
            });
        }
        player.cd = player.fr;
    }

    // 6. Balas
    for(let i=game.bullets.length-1; i>=0; i--) {
        const b = game.bullets[i];
        b.x += b.vx; b.y += b.vy;
        ctx.fillStyle = "yellow"; ctx.fillRect(b.x-3, b.y-3, 6, 6);

        game.enemies.forEach((en, ei) => {
            if(Math.hypot(b.x-en.x, b.y-en.y) < 25) {
                en.hp -= player.dmg;
                game.bullets.splice(i, 1);
                if(en.hp <= 0) {
                    game.enemies.splice(ei, 1);
                    game.kills++;
                    player.xp += 20;
                    if(player.xp >= player.nextXp) {
                        player.level++; player.xp = 0; player.nextXp *= 1.2;
                        showUpgradeMenu();
                    }
                }
            }
        });
        if(b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) game.bullets.splice(i,1);
    }

    // UI
    document.getElementById('hp-count').innerText = Math.floor(player.hp);
    document.getElementById('kill-count').innerText = game.kills;
    document.getElementById('xp-bar-fill').style.width = (player.xp/player.nextXp)*100 + '%';

    requestAnimationFrame(loop);
}

// Iniciar
loop();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Robot Warfare: Pro Edition</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; user-select: none; }
        canvas { display: block; filter: contrast(1.1); }
        
        /* UI GERAL */
        #ui-layer { position: absolute; top: 15px; left: 15px; pointer-events: none; z-index: 5; }
        .stat-box { 
            background: rgba(0, 10, 20, 0.8); padding: 10px 20px; border-radius: 8px; 
            margin-bottom: 8px; border-left: 5px solid #00d2ff; 
            font-family: monospace; font-size: 1.1rem; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* BOSS UI */
        #boss-hud {
            position: absolute; top: 30px; left: 50%; transform: translateX(-50%);
            width: 50%; display: none; z-index: 5; flex-direction: column; align-items: center;
            animation: fadeIn 1s;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        #boss-name { font-weight: 900; font-size: 1.8rem; color: #ff0055; text-transform: uppercase; letter-spacing: 4px; text-shadow: 0 0 15px #ff0055; margin-bottom: 10px; }
        #boss-health-bar-bg { width: 100%; height: 18px; background: #111; border: 2px solid #555; border-radius: 20px; overflow: hidden; box-shadow: 0 0 20px rgba(255, 0, 85, 0.3); }
        #boss-health-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0055, #ffaa00); transition: width 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67); }

        /* MENUS */
        #menu-overlay { 
            position: absolute; inset: 0; 
            background: radial-gradient(circle, rgba(0,20,40,0.95) 0%, rgba(0,0,0,1) 100%); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100;
        }
        .hidden { display: none !important; }
        
        h1 { font-size: 3.5rem; margin-bottom: 10px; color: #00d2ff; text-shadow: 0 0 30px #00d2ff; letter-spacing: 2px; text-align: center; }
        
        /* SHOP CARDS */
        #shop-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 25px; }
        .upgrade-card {
            background-color: #111; background-image: url('assets/card.png'); background-size: cover;
            border: 2px solid #00d2ff33; padding: 20px; width: 160px; min-height: 220px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            cursor: pointer; border-radius: 12px; transition: all 0.3s;
        }
        .upgrade-card:hover { transform: translateY(-8px) scale(1.02); border-color: #00d2ff; box-shadow: 0 0 30px rgba(0, 210, 255, 0.4); }
        .upgrade-card h3 { font-size: 1.2rem; color: #fff; margin: 10px 0; }
        .upgrade-card p { font-size: 0.85rem; color: #aaa; margin-bottom: 15px; }
        .cost { color: #ffd700 !important; font-weight: 900; font-size: 1.1rem !important; margin-top: auto; border-top: 1px solid #333; width: 100%; pt: 10px; }

        .btn { 
            background: #00d2ff; border: none; padding: 18px 60px; 
            color: #000; font-size: 1.3rem; font-weight: 900; cursor: pointer; 
            margin-top: 30px; border-radius: 8px; transition: 0.3s;
        }
        .btn:hover { background: #fff; transform: scale(1.05); box-shadow: 0 0 40px #00d2ff; }

        .ach-toast {
            background: #000; color: gold; padding: 15px 30px; font-weight: bold;
            border: 1px solid gold; border-radius: 4px; box-shadow: 0 0 20px rgba(218, 165, 32, 0.4);
            animation: slideIn 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes slideIn { from { transform: translateX(150%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="stat-box">LEVEL <span id="hud-level">1</span></div>
        <div class="stat-box" style="border-color: #ffd700">XP: <span id="hud-xp">0</span> / <span id="hud-next-xp">100</span></div>
        <div class="stat-box" style="border-color: #ff0055">HP: <span id="hud-hp">100</span> / <span id="hud-max-hp">100</span></div>
        <div class="stat-box" style="border-color: #00ff88">SCORE: <span id="hud-score">0</span></div>
    </div>

    <div id="boss-hud">
        <div id="boss-name">YNVINIR</div>
        <div id="boss-health-bar-bg"><div id="boss-health-bar-fill"></div></div>
    </div>

    <div id="achievement-container" style="position: absolute; bottom: 20px; right: 20px; z-index: 10; display: flex; flex-direction: column; gap: 10px;"></div>

    <div id="menu-overlay">
        <div id="start-screen">
            <h1>WAR OF THE AUTOMATONS</h1>
            <p style="text-align: center; color: #888;">Use WASD para mover e Mouse para atirar</p>
            <center><button class="btn" onclick="game.start()">INICIAR OPERAÇÃO</button></center>
        </div>

        <div id="shop-screen" class="hidden">
            <h2 style="font-size: 2.5rem; text-align: center;">UPGRADES DE COMBATE</h2>
            <p style="text-align: center; color: #ffd700; font-weight: bold;">SKILL POINTS: <span id="shop-points">0</span></p>
            <div id="shop-container">
                <div class="upgrade-card" onclick="game.player.upgrade('damage')">
                    <h3>DANO BRUTAL</h3>
                    <p>Projéteis com maior impacto destrutivo.</p>
                    <p class="cost">1 SP</p>
                </div>
                <div class="upgrade-card" onclick="game.player.upgrade('speed')">
                    <h3>AGILIDADE</h3>
                    <p>Melhora a resposta dos propulsores.</p>
                    <p class="cost">1 SP</p>
                </div>
                <div class="upgrade-card" onclick="game.player.upgrade('firerate')">
                    <h3>CADÊNCIA</h3>
                    <p>Diminui o tempo de recarga entre disparos.</p>
                    <p class="cost">2 SP</p>
                </div>
                <div class="upgrade-card" onclick="game.player.upgrade('multishot')">
                    <h3>NÚCLEO DUPLO</h3>
                    <p>Dispara um projétil adicional.</p>
                    <p class="cost">5 SP</p>
                </div>
                <div class="upgrade-card" onclick="game.player.heal()">
                    <h3>AUTO-REPARO</h3>
                    <p>Restaura 50% dos sistemas de defesa.</p>
                    <p class="cost">1 SP</p>
                </div>
            </div>
            <center><button class="btn" onclick="game.toggleShop()">RETORNAR À BATALHA</button></center>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
// Auxiliares de carregamento
const assets = {
    bgTile: new Image(), player: new Image(), bullet: new Image(), 
    enemyBasic: new Image(), enemyFast: new Image(), enemyTank: new Image(),
    boss: new Image(), ammo: new Image()
};
assets.bgTile.src = 'assets/dungeon_floor.png';
assets.player.src = 'assets/player.png';
assets.bullet.src = 'assets/bullet.png';
assets.enemyBasic.src = 'assets/enemy_robot.png';
assets.enemyFast.src = 'assets/enemy_fast.png';
assets.enemyTank.src = 'assets/enemy_tank.png';
assets.boss.src = 'assets/boss_robot.png';
assets.ammo.src = 'assets/ammo.png';

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let shakeAmount = 0;

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

class Player {
    constructor() { this.reset(); }
    reset() {
        this.x = canvas.width/2; this.y = canvas.height/2;
        this.size = 28; this.speed = 5;
        this.hp = 100; this.maxHp = 100;
        this.level = 1; this.xp = 0; this.xpToNext = 100; this.skillPoints = 0;
        this.damage = 15; this.fireRate = 18; this.multiShot = 1; this.cooldown = 0;
    }
    gainXp(amt) {
        this.xp += amt;
        if (this.xp >= this.xpToNext) {
            this.xp -= this.xpToNext;
            this.level++;
            this.xpToNext = Math.floor(this.xpToNext * 1.4);
            this.skillPoints++;
            this.maxHp += 15;
            this.hp = this.maxHp;
            game.levelUpEffect();
        }
        game.uiDirty = true;
    }
    upgrade(type) {
        const costs = { damage: 1, speed: 1, firerate: 2, multishot: 5 };
        if (this.skillPoints >= costs[type]) {
            this.skillPoints -= costs[type];
            if(type === 'damage') this.damage += 8;
            if(type === 'speed') this.speed += 0.6;
            if(type === 'firerate') this.fireRate = Math.max(4, this.fireRate - 3);
            if(type === 'multishot') this.multiShot++;
            game.uiDirty = true;
            game.showToast("UPGRADE INSTALADO!");
        }
    }
    heal() {
        if (this.skillPoints >= 1 && this.hp < this.maxHp) {
            this.skillPoints--;
            this.hp = Math.min(this.maxHp, this.hp + (this.maxHp * 0.5));
            game.uiDirty = true;
        }
    }
    update(input) {
        let mx = 0, my = 0;
        if (input.keys['w'] || input.keys['arrowup']) my -= 1;
        if (input.keys['s'] || input.keys['arrowdown']) my += 1;
        if (input.keys['a'] || input.keys['arrowleft']) mx -= 1;
        if (input.keys['d'] || input.keys['arrowright']) mx += 1;

        if (mx !== 0 && my !== 0) { // Normalização de movimento diagonal
            const len = Math.sqrt(mx * mx + my * my);
            mx /= len; my /= len;
        }

        this.x += mx * this.speed;
        this.y += my * this.speed;
        this.x = Math.max(this.size, Math.min(canvas.width-this.size, this.x));
        this.y = Math.max(this.size, Math.min(canvas.height-this.size, this.y));

        if (this.cooldown > 0) this.cooldown--;
        if (input.mouseDown && this.cooldown <= 0) {
            for (let i = 0; i < this.multiShot; i++) {
                let spread = (i - (this.multiShot-1)/2) * 0.15;
                let angle = Math.atan2(input.mouseY - this.y, input.mouseX - this.x) + spread;
                game.bullets.push({ x: this.x, y: this.y, vx: Math.cos(angle)*14, vy: Math.sin(angle)*14, dmg: this.damage, type: 'player', life: 100 });
            }
            this.cooldown = this.fireRate;
        }
    }
    draw() {
        ctx.save();
        if (assets.player.complete) ctx.drawImage(assets.player, this.x - 30, this.y - 30, 60, 60);
        else { ctx.fillStyle = '#00d2ff'; ctx.beginPath(); ctx.arc(this.x, this.y, 20, 0, Math.PI*2); ctx.fill(); }
        ctx.restore();
    }
}

class Boss {
    constructor(level) {
        this.x = canvas.width/2; this.y = -100;
        this.hp = 1200 + (level * 300); this.maxHp = this.hp;
        this.size = 90; this.timer = 0; this.phase = 'enter';
    }
    update() {
        if (this.phase === 'enter') { this.y += 2; if (this.y >= 150) this.phase = 'fight'; return; }
        this.x += Math.sin(Date.now()/800) * 3;
        this.timer++;
        if (this.timer % 80 === 0) this.attack();
    }
    attack() {
        const mode = Math.random();
        if (mode < 0.4) {
            for(let i=0; i<12; i++) {
                let a = (Math.PI*2 / 12) * i;
                game.bullets.push({ x: this.x, y: this.y, vx: Math.cos(a)*5, vy: Math.sin(a)*5, dmg: 15, type: 'enemy', life: 300 });
            }
        } else {
            let a = Math.atan2(game.player.y - this.y, game.player.x - this.x);
            game.bullets.push({ x: this.x, y: this.y, vx: Math.cos(a)*9, vy: Math.sin(a)*9, dmg: 25, type: 'enemy', life: 300 });
        }
    }
}

class Game {
    constructor() {
        this.player = new Player();
        this.bullets = []; this.enemies = []; this.drops = []; this.particles = [];
        this.boss = null; this.score = 0; this.isRunning = false; this.isPaused = false;
        this.uiDirty = true; this.input = { keys: {}, mouseX: 0, mouseY: 0, mouseDown: false };
        this.setupInput();
    }
    setupInput() {
        window.onkeydown = e => {
            const k = e.key.toLowerCase();
            this.input.keys[k] = true;
            if (k === 'p' || k === 'escape') this.toggleShop();
        };
        window.onkeyup = e => this.input.keys[e.key.toLowerCase()] = false;
        window.onmousemove = e => { this.input.mouseX = e.clientX; this.input.mouseY = e.clientY; };
        window.onmousedown = () => this.input.mouseDown = true;
        window.onmouseup = () => this.input.mouseDown = false;
    }
    start() {
        this.player.reset(); this.enemies = []; this.bullets = []; this.boss = null; this.score = 0;
        this.isRunning = true; document.getElementById('menu-overlay').classList.add('hidden');
        this.updateHUD(); this.loop();
    }
    toggleShop() {
        if (!this.isRunning) return;
        this.isPaused = !this.isPaused;
        document.getElementById('menu-overlay').classList.toggle('hidden', !this.isPaused);
        document.getElementById('shop-screen').classList.toggle('hidden', !this.isPaused);
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('shop-points').innerText = this.player.skillPoints;
    }
    levelUpEffect() {
        shakeAmount = 15;
        this.showToast("LEVEL UP! SISTEMAS OTIMIZADOS");
        this.toggleShop();
    }
    showToast(msg) {
        const c = document.getElementById('achievement-container');
        const d = document.createElement('div'); d.className = 'ach-toast'; d.innerText = msg;
        c.appendChild(d); setTimeout(() => d.remove(), 2500);
    }
    spawnEnemy() {
        if (this.boss || this.enemies.length > 20) return;
        let x, y, side = Math.floor(Math.random()*4);
        if(side==0){ x=Math.random()*canvas.width; y=-50; }
        else if(side==1){ x=canvas.width+50; y=Math.random()*canvas.height; }
        else if(side==2){ x=Math.random()*canvas.width; y=canvas.height+50; }
        else { x=-50; y=Math.random()*canvas.height; }

        let r = Math.random(), type = 'basic', hp = 30 + (this.player.level * 10), speed = 2, img = assets.enemyBasic;
        if(r < 0.15 && this.player.level > 2) { type='tank'; hp*=3; speed=1; img=assets.enemyTank; }
        else if(r > 0.85) { type='fast'; hp*=0.6; speed=4.5; img=assets.enemyFast; }
        this.enemies.push({ x, y, hp, maxHp: hp, speed, size: type==='tank'?35:25, img });
    }
    loop() {
        if (!this.isRunning || this.isPaused) return;
        
        // Efeito de Tremedeira (Camera Shake)
        ctx.save();
        if(shakeAmount > 0) {
            ctx.translate(Math.random()*shakeAmount - shakeAmount/2, Math.random()*shakeAmount - shakeAmount/2);
            shakeAmount *= 0.9;
        }

        // Fundo
        if (assets.bgTile.complete) {
            const ptrn = ctx.createPattern(assets.bgTile, 'repeat');
            ctx.fillStyle = ptrn; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.fillStyle = 'rgba(0,0,0,0.4)'; ctx.fillRect(0,0,canvas.width, canvas.height);
        } else { ctx.fillStyle='#050505'; ctx.fillRect(0,0,canvas.width, canvas.height); }

        // Spawn Boss
        if (this.player.level % 5 === 0 && !this.boss && this.enemies.length === 0) {
            this.boss = new Boss(this.player.level);
            document.getElementById('boss-hud').style.display = 'flex';
        } else if (Math.random() < 0.02) this.spawnEnemy();

        // Updates
        this.player.update(this.input);
        this.player.draw();

        if (this.boss) {
            this.boss.update();
            if(assets.boss.complete) ctx.drawImage(assets.boss, this.boss.x-this.boss.size, this.boss.y-this.boss.size, this.boss.size*2, this.boss.size*2);
            document.getElementById('boss-health-bar-fill').style.width = (this.boss.hp/this.boss.maxHp*100) + '%';
        }

        // Balas (Otimizado)
        for(let i=this.bullets.length-1; i>=0; i--) {
            let b = this.bullets[i];
            b.x += b.vx; b.y += b.vy; b.life--;
            ctx.drawImage(assets.bullet, b.x-8, b.y-8, 16, 16);

            if(b.life <= 0) { this.bullets.splice(i,1); continue; }

            if(b.type === 'player') {
                if(this.boss) {
                    if(Math.hypot(b.x-this.boss.x, b.y-this.boss.y) < this.boss.size) {
                        this.boss.hp -= b.dmg; b.life = 0;
                        if(this.boss.hp <= 0) {
                            this.player.gainXp(1000); this.boss = null;
                            document.getElementById('boss-hud').style.display = 'none';
                            shakeAmount = 30; this.showToast("BOSS ANIQUILADO!");
                        }
                    }
                }
                this.enemies.forEach((e, ei) => {
                    if(Math.hypot(b.x-e.x, b.y-e.y) < e.size) {
                        e.hp -= b.dmg; b.life = 0;
                        if(e.hp <= 0) { 
                            this.enemies.splice(ei, 1); 
                            this.score += 50; this.player.gainXp(20);
                            if(Math.random() < 0.1) this.drops.push({x: e.x, y: e.y});
                        }
                    }
                });
            } else { // Bala inimiga no player
                if(Math.hypot(b.x-this.player.x, b.y-this.player.y) < this.player.size) {
                    this.player.hp -= b.dmg; b.life = 0; shakeAmount = 8;
                    this.uiDirty = true;
                    if(this.player.hp <= 0) this.gameOver();
                }
            }
        }

        // Inimigos
        this.enemies.forEach((e, i) => {
            let a = Math.atan2(this.player.y-e.y, this.player.x-e.x);
            e.x += Math.cos(a)*e.speed; e.y += Math.sin(a)*e.speed;
            ctx.drawImage(e.img, e.x-e.size, e.y-e.size, e.size*2, e.size*2);
            if(Math.hypot(this.player.x-e.x, this.player.y-e.y) < this.player.size + e.size) {
                this.player.hp -= 0.5; this.uiDirty = true;
                if(this.player.hp <= 0) this.gameOver();
            }
        });

        // Drops
        this.drops.forEach((d, i) => {
            ctx.drawImage(assets.ammo, d.x-15, d.y-15, 30, 30);
            if(Math.hypot(this.player.x-d.x, this.player.y-d.y) < 40) {
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + 25);
                this.drops.splice(i,1); this.uiDirty = true;
            }
        });

        ctx.restore();
        if(this.uiDirty) this.updateHUD();
        requestAnimationFrame(() => this.loop());
    }
    updateHUD() {
        document.getElementById('hud-level').innerText = this.player.level;
        document.getElementById('hud-xp').innerText = Math.floor(this.player.xp);
        document.getElementById('hud-next-xp').innerText = this.player.xpToNext;
        document.getElementById('hud-hp').innerText = Math.floor(this.player.hp);
        document.getElementById('hud-max-hp').innerText = this.player.maxHp;
        document.getElementById('hud-score').innerText = this.score;
        this.uiDirty = false;
    }
    gameOver() {
        this.isRunning = false;
        alert("SISTEMAS CRÍTICOS: MISSÃO FALHOU!\nScore Final: " + this.score);
        location.reload();
    }
}

const game = new Game();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Automatons: Ultimate Survival</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Share Tech Mono', monospace; }
        #ui { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 10; color: #0ff; }
        .stat { background: rgba(0,0,0,0.8); padding: 10px; border: 1px solid #0ff; margin-bottom: 5px; min-width: 180px; }
        #xp-bar { position: absolute; top: 0; width: 100%; height: 6px; background: #222; }
        #xp-fill { width: 0%; height: 100%; background: #ffd700; box-shadow: 0 0 10px #ffd700; }
        .modal { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 100; color: white; }
        .card { width: 200px; padding: 20px; border: 2px solid #0ff; margin: 10px; cursor: pointer; text-align: center; }
        .card:hover { background: #003333; }
    </style>
</head>
<body>

    <div id="xp-bar"><div id="xp-fill"></div></div>
    <div id="ui">
        <div class="stat">SISTEMA: <span id="txt-biome">Dungeon</span></div>
        <div class="stat">WAVE: <span id="txt-wave">1</span></div>
        <div class="stat">ABATES: <span id="txt-kills">0</span></div>
        <div class="stat">HP: <span id="txt-hp">100/100</span></div>
    </div>

    <div id="levelup" class="modal">
        <h1>UPGRADE DE NÚCLEO</h1>
        <div style="display:flex" id="cards"></div>
    </div>

    <script>
        const CONFIG = {
            ASSETS: {
                player: 'assets/player.png',
                enemy: 'assets/enemy_robot.png',
                enemyFast: 'assets/enemy_fast.png',
                enemyTank: 'assets/enemy_tank.png',
                boss: 'assets/boss_robot.png',
                bullet: 'assets/bullet.png',
                xp: 'assets/ammo.png',
                // Biomas
                bg_dungeon: 'assets/dungeon_floor.png',
                bg_cryo: 'assets/bg_cryo.png',
                bg_glitch: 'assets/bg_glitch.png',
                bg_cathedral: 'assets/bg_cathedral.png',
                bg_neon: 'assets/bg_neon.png'
            }
        };

        class MainScene extends Phaser.Scene {
            constructor() { super('MainScene'); }

            preload() {
                // Carrega todos os assets da lista
                Object.entries(CONFIG.ASSETS).forEach(([key, path]) => {
                    this.load.image(key, path);
                });

                // Fallback: Se a imagem falhar, cria uma textura colorida para não ficar invisível
                this.load.on('loaderror', (file) => {
                    let color = 0x00ffff;
                    if(file.key.includes('enemy')) color = 0xff0000;
                    if(file.key.includes('bg')) color = 0x222222;
                    if(file.key === 'boss') color = 0xff00ff;
                    
                    const graphics = this.make.graphics({x: 0, y: 0, add: false});
                    graphics.fillStyle(color, 1);
                    graphics.fillRect(0, 0, 64, 64);
                    graphics.generateTexture(file.key, 64, 64);
                });
            }

            create() {
                this.physics.world.setBounds(0, 0, 3000, 3000);
                
                // Inicializa Fundo
                this.bg = this.add.tileSprite(0, 0, 3000, 3000, 'bg_dungeon').setOrigin(0);

                // Player
                this.player = this.physics.add.sprite(1500, 1500, 'player');
                this.player.stats = { hp: 100, maxHp: 100, speed: 200, dmg: 20, xp: 0, nextXp: 100, level: 1 };
                this.player.setCollideWorldBounds(true);
                this.cameras.main.startFollow(this.player, true, 0.1, 0.1);

                // Grupos
                this.enemies = this.physics.add.group();
                this.bullets = this.physics.add.group();
                this.xpOrbs = this.physics.add.group();

                // Variáveis de Progressão
                this.kills = 0;
                this.wave = 1;
                this.isPaused = false;

                // Teclado
                this.keys = this.input.keyboard.addKeys('W,A,S,D');

                // Colisões
                this.physics.add.overlap(this.bullets, this.enemies, this.hitEnemy, null, this);
                this.physics.add.overlap(this.player, this.enemies, this.hitPlayer, null, this);
                this.physics.add.overlap(this.player, this.xpOrbs, this.collectXp, null, this);

                // Loop de tiro e spawn
                this.time.addEvent({ delay: 500, callback: this.autoFire, loop: true, callbackScope: this });
                this.time.addEvent({ delay: 1000, callback: this.spawnHandler, loop: true, callbackScope: this });
            }

            update() {
                if (this.isPaused) return;

                // Movimentação
                let vx = 0, vy = 0;
                if (this.keys.W.isDown) vy = -1;
                if (this.keys.S.isDown) vy = 1;
                if (this.keys.A.isDown) vx = -1;
                if (this.keys.D.isDown) vx = 1;

                const speed = this.player.stats.speed;
                const vec = new Phaser.Math.Vector2(vx, vy).normalize().scale(speed);
                this.player.setVelocity(vec.x, vec.y);

                // Lógica de Troca de Bioma (CONFORME SUA SOLICITAÇÃO)
                this.checkBiomeLogic();
                
                // Inimigos olham para o player
                this.enemies.getChildren().forEach(e => {
                    this.physics.moveToObject(e, this.player, e.speed || 100);
                });
            }

            checkBiomeLogic() {
                let currentKey = 'bg_dungeon';
                let biomeName = "Dungeon";

                if (this.wave >= 15) { 
                    currentKey = 'bg_cathedral'; biomeName = "Catedral (Final)";
                } else if (this.kills >= 500) {
                    currentKey = 'bg_neon'; biomeName = "Neon City";
                } else if (this.wave >= 10) {
                    currentKey = 'bg_glitch'; biomeName = "Glitch Void";
                } else if (this.wave >= 5) {
                    currentKey = 'bg_cryo'; biomeName = "Setor Cryo";
                }

                if (this.bg.texture.key !== currentKey) {
                    this.bg.setTexture(currentKey);
                    document.getElementById('txt-biome').innerText = biomeName;
                    this.cameras.main.flash(500, 0, 255, 255);
                }
            }

            spawnHandler() {
                if (this.enemies.countActive() > 40 || this.isPaused) return;

                // Spawn fora da tela
                const x = this.player.x + Phaser.Math.Between(-600, 600);
                const y = this.player.y + Phaser.Math.Between(-600, 600);
                if (Phaser.Math.Distance.Between(x, y, this.player.x, this.player.y) < 300) return;

                let type = 'enemy';
                let hp = 40 + (this.wave * 10);
                let speed = 100;

                if (this.wave > 8) { type = 'enemyFast'; speed = 180; hp *= 0.7; }
                if (this.wave > 12) { type = 'enemyTank'; speed = 50; hp *= 3; }

                const en = this.enemies.create(x, y, type);
                en.hp = hp; en.speed = speed;
            }

            autoFire() {
                const target = this.physics.closest(this.player, this.enemies.getChildren());
                if (!target || this.isPaused) return;

                const b = this.bullets.create(this.player.x, this.player.y, 'bullet');
                this.physics.moveToObject(b, target, 500);
                b.dmg = this.player.stats.dmg;
            }

            hitEnemy(bullet, enemy) {
                bullet.destroy();
                enemy.hp -= bullet.dmg;
                enemy.setTint(0xff0000);
                this.time.delayedCall(100, () => enemy.clearTint());

                if (enemy.hp <= 0) {
                    this.kills++;
                    const orb = this.xpOrbs.create(enemy.x, enemy.y, 'xp');
                    orb.val = 20;
                    enemy.destroy();
                    this.updateUI();

                    // Wave sobe a cada 20 kills
                    if (this.kills % 20 === 0) {
                        this.wave++;
                        if (this.wave % 5 === 0) this.spawnBoss();
                        this.updateUI();
                    }
                }
            }

            spawnBoss() {
                const boss = this.enemies.create(this.player.x, this.player.y - 300, 'boss');
                boss.hp = 1000 * (this.wave / 5);
                boss.speed = 70;
                boss.setScale(2);
            }

            hitPlayer(player, enemy) {
                player.stats.hp -= 0.5;
                this.updateUI();
                if (player.stats.hp <= 0) location.reload();
            }

            collectXp(player, orb) {
                player.stats.xp += orb.val;
                orb.destroy();
                if (player.stats.xp >= player.stats.nextXp) this.levelUp();
                this.updateUI();
            }

            levelUp() {
                this.isPaused = true;
                this.physics.pause();
                this.player.stats.xp = 0;
                this.player.stats.nextXp *= 1.4;
                this.player.stats.level++;

                const modal = document.getElementById('levelup');
                const cards = document.getElementById('cards');
                modal.style.display = 'flex';
                cards.innerHTML = '';

                const opts = [
                    { t: '+ DANO', f: () => this.player.stats.dmg += 15 },
                    { t: '+ VELOCIDADE', f: () => this.player.stats.speed += 30 },
                    { t: '+ VIDA MAX', f: () => { this.player.stats.maxHp += 50; this.player.stats.hp = this.player.stats.maxHp; } }
                ];

                opts.forEach(o => {
                    const d = document.createElement('div');
                    d.className = 'card';
                    d.innerText = o.t;
                    d.onclick = () => {
                        o.f();
                        modal.style.display = 'none';
                        this.isPaused = false;
                        this.physics.resume();
                    };
                    cards.appendChild(d);
                });
            }

            updateUI() {
                document.getElementById('txt-kills').innerText = this.kills;
                document.getElementById('txt-wave').innerText = this.wave;
                document.getElementById('txt-hp').innerText = `${Math.floor(this.player.stats.hp)}/${this.player.stats.maxHp}`;
                const perc = (this.player.stats.xp / this.player.stats.nextXp) * 100;
                document.getElementById('xp-fill').style.width = perc + '%';
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            physics: { default: 'arcade' },
            scene: MainScene
        };
        new Phaser.Game(config);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>War of the Automatons - Survivor Mode (v1.0.2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser.js"></script>
  <style>
    body { margin: 0; overflow: hidden; background: #000008c7; }
    canvas { display: block; margin: auto; }
    .menu-overlay, .shop-overlay, .pause-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; color: #FFF; }
    .menu-container, .shop-container, .pause-container { background-color: #333; border: 2px solid #555; padding: 20px; border-radius: 8px; text-align: center; width: 80%; max-width: 900px; }
    .menu-title, .shop-title, .pause-title { font-size: 36px; margin-bottom: 20px; color: #00FFFF; }
    .cards-container, .shop-items-container { display: flex; justify-content: space-around; gap: 20px; flex-wrap: wrap; }
    .card, .shop-item { background-color: #222; border: 1px solid #444; border-radius: 8px; padding: 15px; width: 250px; display: flex; flex-direction: column; align-items: center; text-align: left; min-height: 220px; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 5px 20px rgba(0, 255, 255, 0.5); }
    .card-title, .shop-item-name { font-size: 22px; color: #FFD700; }
    .card-button, .shop-item-button, .shop-close-button, .pause-close-button, .pause-tab-button { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 15px; }
    .card-button { background-color: #008CBA; color: white; }
    .shop-item-button { background-color: #28a745; color: white; }
    .shop-close-button, .pause-close-button { background-color: #dc3545; color: white; }
    .card-rarity { font-size: 12px; font-style: italic; margin: 5px 0 10px 0; }
  </style>
</head>
<body>
<script>
/* -------------- CONFIG DO GAME -------------- */
const config = {
  type: Phaser.AUTO,
  width: 1320,
  height: 590,
  backgroundColor: '#000000',
  physics: {
    default: 'arcade',
    arcade: { debug: false, gravity: { y: 0 } }
  },
  scene: { preload, create, update }
};

const GAME_CONFIG = {
    PLAYER: {
        INITIAL_SCALE: 0.08,
        DASH_DURATION: 150, DASH_DISTANCE: 300, DASH_COOLDOWN_BASE: 3000,
        ACCELERATION: 2000, DRAG: 0.6,
        BASE_MAGNET_RANGE: 200,
        BASE_PIERCING: 1
    },
    BULLET: { INITIAL_SPEED: 900, INITIAL_SCALE: 0.01 },
    WAVE: {
        INITIAL_ENEMY_COUNT: 10,
        ENEMY_INCREMENT_PER_WAVE: 3,
        INITIAL_SPAWN_RATE: 1200,
        MAX_ENEMIES_ON_SCREEN: 100
    }
};

/* -------------- NORMALIZA AS PARADAS -------------- */
let player, cursors, bullets, enemies, xpGemsGroup;
let hud;
let currentWeapon = 1;
let gamePaused = false, levelUpMenuOpen = false;
let lastShoot = 0;
let nearestEnemy = null;

/* -------------- STATS DO BRABO -------------- */
let waveNumber = 1;
let enemiesRemaining = GAME_CONFIG.WAVE.INITIAL_ENEMY_COUNT;
let enemySpawnRate = GAME_CONFIG.WAVE.INITIAL_SPAWN_RATE;

let playerStats = {
  life: 5, maxLife: 5,
  bulletDamage: 2,
  fireRate: 350,
  playerSpeed: 260,
  xp: 0,
  level: 1,
  xpToNextLevel: 50,
  magnetRange: GAME_CONFIG.PLAYER.BASE_MAGNET_RANGE,
  piercingCount: GAME_CONFIG.PLAYER.BASE_PIERCING,
  dashAvailable: true,
  dashCooldown: false
};

/* -------------- MOBS SEM FRESCURA -------------- */
const enemyTypes = {
  normal: { texture: 'enemy_robot', baseHealth: 2, speed: 90, scale: 0.06, xpValue: 5 },
  fast: { texture: 'enemy_fast', baseHealth: 1.2, speed: 150, scale: 0.06, xpValue: 6 },
  tank: { texture: 'enemy_tank', baseHealth: 6, speed: 50, scale: 0.07, xpValue: 12 }
};

/* -------------- ITENS -------------- */
const itemRarities = {
    common: { color: '#FFFFFF' },
    rare: { color: '#00BFFF' }
};

const itemOptions = [
  { nome: "Dano +20%", descricao: "Bate mais forte", rarity: 'common', efeito: () => playerStats.bulletDamage *= 1.2 },
  { nome: "Atk Speed +10%", descricao: "Atira mais rápido", rarity: 'common', efeito: () => playerStats.fireRate *= 0.9 }
];

/* -------------- HUD ZIKA -------------- */
class HUD extends Phaser.GameObjects.Container {
  constructor(scene) {
    super(scene);
    scene.add.existing(this);
    this.lifeText = scene.add.text(10, 10, "", { fontSize: 20, fill: "#FF0000" });
    this.levelText = scene.add.text(10, 40, "", { fontSize: 20, fill: "#FFFF00" });
  }
  updateAll() {
    this.lifeText.setText(`Vida: ${playerStats.life}/${playerStats.maxLife}`);
    this.levelText.setText(`Nível: ${playerStats.level}`);
  }
}

/* -------------- LOAD -------------- */
function preload() {
  this.load.image('player', 'assets/player.png');
  this.load.image('bullet', 'assets/bullet.png');
  this.load.image('enemy_robot', 'assets/enemy_robot.png');
  this.load.image('enemy_fast', 'assets/enemy_fast.png');
  this.load.image('enemy_tank', 'assets/enemy_tank.png');
  this.load.image('ammo', 'assets/ammo.png');
}

/* -------------- CREATE -------------- */
function create() {
  player = this.physics.add.sprite(config.width/2, config.height/2, 'player')
    .setScale(GAME_CONFIG.PLAYER.INITIAL_SCALE)
    .setCollideWorldBounds(true);

  cursors = this.input.keyboard.createCursorKeys();
  this.keySpace = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);

  bullets = this.physics.add.group({ classType: Bullet, runChildUpdate: true });
  enemies = this.physics.add.group({ classType: Enemy, runChildUpdate: true });
  xpGemsGroup = this.physics.add.group({ classType: XPGem, runChildUpdate: true });

  this.physics.add.overlap(bullets, enemies, bulletHitEnemy, null, this);
  this.physics.add.overlap(player, xpGemsGroup, collectGem, null, this);
  this.physics.add.collider(player, enemies, playerHitEnemy, null, this);

  hud = new HUD(this);
  hud.updateAll();

  this.spawner = this.time.addEvent({
    delay: enemySpawnRate,
    callback: spawnEnemy,
    callbackScope: this,
    loop: true
  });
}

/* -------------- UPDATE -------------- */
function update(time) {
  if (gamePaused) return;

  player.setVelocity(0);
  if (cursors.left.isDown) player.setVelocityX(-playerStats.playerSpeed);
  if (cursors.right.isDown) player.setVelocityX(playerStats.playerSpeed);
  if (cursors.up.isDown) player.setVelocityY(-playerStats.playerSpeed);
  if (cursors.down.isDown) player.setVelocityY(playerStats.playerSpeed);

  // sem rotação agora
  nearestEnemy = findNearestEnemy();
  if (nearestEnemy && time > lastShoot) {
    shootBullet.call(this, nearestEnemy);
    lastShoot = time + playerStats.fireRate;
  }
}

/* -------------- FUNÇÕES DO GAMEPLAY -------------- */
function findNearestEnemy() {
  let minDist = Infinity, target = null;
  enemies.children.each(enemy => {
    if (!enemy.active) return;
    const d = Phaser.Math.Distance.Between(player.x, player.y, enemy.x, enemy.y);
    if (d < minDist) { minDist = d; target = enemy; }
  });
  return target;
}

function shootBullet(target) {
  const angle = Phaser.Math.Angle.Between(player.x, player.y, target.x, target.y);
  const bullet = bullets.get(player.x, player.y);
  if (bullet) bullet.fire(angle, playerStats.bulletDamage, playerStats.piercingCount);
}

function bulletHitEnemy(b, e) {
  e.takeDamage(b.damage);
  b.piercing--;
  if (b.piercing <= 0) b.kill();

  if (e.health <= 0) {
    dropGem(e.x, e.y, e.enemyType.xpValue);
    e.kill();
  }
}

function spawnEnemy() {
  if (enemies.countActive() >= GAME_CONFIG.WAVE.MAX_ENEMIES_ON_SCREEN) return;
  const type = Phaser.Utils.Array.GetRandom(Object.keys(enemyTypes));
  const data = enemyTypes[type];
  const enemy = enemies.get(
    Phaser.Math.Between(0, config.width),
    Phaser.Math.Between(0, config.height)
  );
  if (enemy) enemy.spawn(data);
}

function dropGem(x, y, xp) {
  const g = xpGemsGroup.get(x, y);
  if (g) g.spawn(xp);
}

function collectGem(p, g) {
  playerStats.xp += g.xpValue;
  hud.updateAll();
  g.kill();
}

function playerHitEnemy() {
  playerStats.life--;
  hud.updateAll();
  if (playerStats.life <= 0) this.scene.restart();
}

/* -------------- CLASSES -------------- */
class Bullet extends Phaser.Physics.Arcade.Sprite {
  fire(a, dmg, pierce) {
    this.setActive(true).setVisible(true);
    this.damage = dmg;
    this.piercing = pierce;
    this.scene.physics.velocityFromRotation(a, GAME_CONFIG.BULLET.INITIAL_SPEED, this.body.velocity);
  }
  kill(){ this.disableBody(true,true); }
}

class Enemy extends Phaser.Physics.Arcade.Sprite {
  spawn(d){
    this.setActive(true).setVisible(true);
    this.setTexture(d.texture);
    this.setScale(d.scale);
    this.health = d.baseHealth * (1 + waveNumber*0.05); /* NERF AQUI */
    this.speed = d.speed;
  }
  update(){
    if (!this.active) return;
    this.scene.physics.moveToObject(this, player, this.speed);
  }
  takeDamage(v){ this.health-=v; }
  kill(){ this.disableBody(true,true); }
}

class XPGem extends Phaser.Physics.Arcade.Sprite {
  spawn(xp){
    this.setActive(true).setVisible(true);
    this.xpValue = xp;
  }
  kill(){ this.disableBody(true,true); }
}

new Phaser.Game(config);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Robot Warfare: Mission System</title>
    <style>
        body { margin: 0; overflow: hidden; background: #050505; color: white; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; }
        
        /* UI GERAL */
        #ui-layer { position: absolute; top: 10px; left: 10px; pointer-events: none; z-index: 5; }
        .stat-box { 
            background: rgba(0,0,0,0.75); padding: 8px 15px; border-radius: 4px; 
            margin-bottom: 5px; border-left: 4px solid #00d2ff; font-weight: bold;
        }

        /* MISS√ÉO UI */
        #mission-hud {
            position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
            background: rgba(255, 166, 0, 0.2); border: 2px solid orange;
            padding: 10px 25px; border-radius: 50px; text-align: center;
            min-width: 300px; display: none; z-index: 5;
            box-shadow: 0 0 15px rgba(255, 166, 0, 0.3);
        }
        #mission-title { font-weight: bold; color: orange; text-transform: uppercase; margin: 0; }
        #mission-timer { font-size: 0.8rem; opacity: 0.8; }

        /* BOSS UI */
        #boss-hud {
            position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
            width: 60%; display: none; z-index: 5; flex-direction: column; align-items: center;
        }
        #boss-health-bar-bg { width: 100%; height: 12px; background: #333; border: 1px solid white; border-radius: 6px; overflow: hidden; }
        #boss-health-bar-fill { width: 100%; height: 100%; background: linear-gradient(90deg, #ff0055, #ff5500); }

        /* MENUS & LOJA */
        #menu-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.92); display: flex; flex-direction: column; 
            align-items: center; justify-content: center; z-index: 100;
        }
        .hidden { display: none !important; }
        
        #shop-container { display: flex; gap: 15px; flex-wrap: wrap; justify-content: center; margin-top: 20px; }
        .upgrade-card {
            background-image: url('assets/card.png'); background-size: cover; background-position: center;
            background-color: #222; border: 2px solid #444; padding: 15px; width: 160px; height: 250px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            cursor: pointer; border-radius: 12px; transition: 0.2s; pointer-events: all;
        }
        .upgrade-card:hover { transform: translateY(-5px); border-color: #00d2ff; }
        .upgrade-card h3 { font-size: 1.2rem; margin: 10px 0; text-shadow: 0 2px 4px black; }
        .upgrade-card p { font-size: 0.8rem; color: #ddd; }
        .cost { color: #ffd700; font-weight: bold; margin-top: auto; padding-bottom: 10px; }

        .btn { 
            background: linear-gradient(45deg, #00d2ff, #0077ff); border: none; padding: 12px 40px; 
            color: white; font-size: 1.2rem; font-weight: bold; cursor: pointer; 
            margin: 20px; border-radius: 50px; pointer-events: all;
        }

        #achievement-container { position: absolute; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 6; }
        .ach-toast { background: rgba(0, 40, 80, 0.9); color: white; padding: 12px; border-radius: 5px; border-left: 5px solid #ffd700; animation: slideIn 0.5s; }
        @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="stat-box">üõ°Ô∏è N√≠vel: <span id="hud-level">1</span></div>
        <div class="stat-box">‚ú® XP: <span id="hud-xp">0</span> / <span id="hud-next-xp">100</span></div>
        <div class="stat-box" style="border-color: #ff0055">‚ù§Ô∏è HP: <span id="hud-hp">100</span></div>
        <div class="stat-box" style="border-color: gold">üèÜ SP: <span id="hud-sp">0</span></div>
    </div>

    <div id="mission-hud">
        <p id="mission-title">NENHUMA MISS√ÉO</p>
        <div id="mission-timer">Tempo: --:--</div>
    </div>

    <div id="boss-hud">
        <div style="color: #ff0055; font-weight: bold; margin-bottom: 5px;">BOSS</div>
        <div id="boss-health-bar-bg"><div id="boss-health-bar-fill"></div></div>
    </div>

    <div id="achievement-container"></div>

    <div id="menu-overlay">
        <div id="start-screen">
            <h1>ROBOT WARFARE</h1>
            <button class="btn" id="btn-start">INICIAR MISS√ÉO</button>
        </div>

        <div id="shop-screen" class="hidden">
            <h2 style="color:gold;">UPGRADES DISPON√çVEIS</h2>
            <div id="shop-container">
                <div class="upgrade-card" data-upgrade="damage">
                    <h3>Dano</h3><p>Mais poder de fogo.</p><p class="cost">1 SP</p>
                </div>
                <div class="upgrade-card" data-upgrade="speed">
                    <h3>Motor</h3><p>Velocidade de movimento.</p><p class="cost">1 SP</p>
                </div>
                <div class="upgrade-card" data-upgrade="firerate">
                    <h3>Cad√™ncia</h3><p>Atire mais r√°pido.</p><p class="cost">2 SP</p>
                </div>
                <div class="upgrade-card" data-upgrade="multishot">
                    <h3>Multi-Tiro</h3><p>Adiciona canh√µes extras.</p><p class="cost">5 SP</p>
                </div>
                <div class="upgrade-card" data-upgrade="heal">
                    <h3>Reparo</h3><p>Cura 50% do HP.</p><p class="cost">1 SP</p>
                </div>
            </div>
            <button class="btn" id="btn-close-shop">VOLTAR</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
/** * CONFIGURA√á√ÉO DE ASSETS 
 */
const assets = {
    bgTile: new Image(), cardBg: new Image(), player: new Image(), bullet: new Image(),
    enemyBasic: new Image(), enemyFast: new Image(), enemyTank: new Image(),
    boss: new Image(), ammo: new Image()
};
assets.bgTile.src = 'assets/dungeon_floor.png';
assets.cardBg.src = 'assets/card.png';
assets.player.src = 'assets/player.png';
assets.bullet.src = 'assets/bullet.png';
assets.enemyBasic.src = 'assets/enemy_robot.png';
assets.enemyFast.src = 'assets/enemy_fast.png';
assets.enemyTank.src = 'assets/enemy_tank.png';
assets.boss.src = 'assets/boss_robot.png';
assets.ammo.src = 'assets/ammo.png';

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

/**
 * LOGICA DO JOGO
 */
class Game {
    constructor() {
        this.player = {
            x: 0, y: 0, size: 30, speed: 5, hp: 100, maxHp: 100,
            level: 1, xp: 0, xpToNext: 100, skillPoints: 0,
            damage: 15, fireRate: 15, multiShot: 1, cooldown: 0
        };
        this.bullets = []; this.enemies = []; this.drops = []; this.particles = [];
        this.boss = null; this.score = 0; this.isRunning = false; this.isPaused = false;
        this.input = { keys: {}, mouseX: 0, mouseY: 0, mouseDown: false };
        
        // Sistema de Miss√µes
        this.currentMission = null;
        this.missionTimer = 0;
        this.missionCooldown = 300; // Tempo entre miss√µes (frames)
        this.statMultipliers = { enemySpeed: 1, enemyHealth: 1, xpGain: 1, playerDamage: 1 };

        this.init();
    }

    init() {
        // Eventos de Input
        window.addEventListener('keydown', e => this.input.keys[e.key] = true);
        window.addEventListener('keyup', e => this.input.keys[e.key] = false);
        window.addEventListener('mousemove', e => { this.input.mouseX = e.clientX; this.input.mouseY = e.clientY; });
        window.addEventListener('mousedown', () => this.input.mouseDown = true);
        window.addEventListener('mouseup', () => this.input.mouseDown = false);

        // BOT√ïES - Resolvendo problema de clique
        document.getElementById('btn-start').addEventListener('click', () => this.start());
        document.getElementById('btn-close-shop').addEventListener('click', () => this.toggleShop());
        
        // Cartas da Loja
        document.querySelectorAll('.upgrade-card').forEach(card => {
            card.addEventListener('click', (e) => {
                const type = card.getAttribute('data-upgrade');
                this.buyUpgrade(type);
            });
        });
    }

    start() {
        this.player.x = canvas.width/2; this.player.y = canvas.height/2;
        this.player.hp = 100; this.player.skillPoints = 0; this.player.level = 1;
        this.enemies = []; this.bullets = []; this.isRunning = true;
        document.getElementById('menu-overlay').classList.add('hidden');
        requestAnimationFrame(() => this.loop());
    }

    toggleShop(force = false) {
        this.isPaused = force || !this.isPaused;
        const shop = document.getElementById('shop-screen');
        const overlay = document.getElementById('menu-overlay');
        if (this.isPaused) {
            overlay.classList.remove('hidden');
            shop.classList.remove('hidden');
            document.getElementById('start-screen').classList.add('hidden');
        } else {
            overlay.classList.add('hidden');
            requestAnimationFrame(() => this.loop());
        }
    }

    buyUpgrade(type) {
        const costs = { damage: 1, speed: 1, firerate: 2, multishot: 5, heal: 1 };
        if (this.player.skillPoints >= costs[type]) {
            this.player.skillPoints -= costs[type];
            if(type === 'damage') this.player.damage += 8;
            if(type === 'speed') this.player.speed += 0.8;
            if(type === 'firerate') this.player.fireRate = Math.max(4, this.player.fireRate - 2);
            if(type === 'multishot') this.player.multiShot++;
            if(type === 'heal') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 50);
            this.showToast("Upgrade Adquirido!");
            updateUI();
        } else {
            this.showToast("Pontos Insuficientes!");
        }
    }

    /** 10 MISS√ïES / EVENTOS ALEAT√ìRIOS */
    triggerRandomMission() {
        const missions = [
            { id: 'pacifist', title: "Pacifista: N√£o atire!", duration: 400, msg: "Sobreviva sem disparar para ganhar 200 XP!" },
            { id: 'tank_inv', title: "Invas√£o de Tanks", duration: 500, msg: "Todos os rob√¥s agora s√£o blindados!" },
            { id: 'speed_up', title: "Sobrecarga de Motores", duration: 400, msg: "Inimigos est√£o 2x mais r√°pidos!" },
            { id: 'glass', title: "Canh√£o de Vidro", duration: 300, msg: "Dano x3, mas voc√™ morre com 1 toque!" },
            { id: 'supply', title: "Chuva de Suprimentos", duration: 300, msg: "V√°rias caixas de reparo caindo!" },
            { id: 'gold', title: "Corrida do Ouro", duration: 400, msg: "Inimigos d√£o o dobro de XP!" },
            { id: 'swarm', title: "Enxame de Rob√¥s", duration: 300, msg: "Muitos rob√¥s r√°pidos aparecendo!" },
            { id: 'blackout', title: "Pane El√©trica", duration: 400, msg: "Visibilidade reduzida!" },
            { id: 'frenzy', title: "Frenesi de Disparo", duration: 300, msg: "Velocidade de tiro infinita!" },
            { id: 'boss_shadow', title: "Sombra do Chefe", duration: 500, msg: "Um mini-boss apareceu!" }
        ];

        this.currentMission = missions[Math.floor(Math.random() * missions.length)];
        this.missionTimer = this.currentMission.duration;
        this.showToast(this.currentMission.msg);
        
        // Reset multipliers
        this.statMultipliers = { enemySpeed: 1, enemyHealth: 1, xpGain: 1, playerDamage: 1 };
        
        // Aplica efeitos imediatos
        if(this.currentMission.id === 'tank_inv') this.statMultipliers.enemyHealth = 3;
        if(this.currentMission.id === 'speed_up') this.statMultipliers.enemySpeed = 2;
        if(this.currentMission.id === 'gold') this.statMultipliers.xpGain = 2;
        if(this.currentMission.id === 'glass') this.statMultipliers.playerDamage = 3;
        if(this.currentMission.id === 'supply') { for(let i=0; i<5; i++) this.drops.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height}); }
    }

    updateMissions() {
        if (!this.currentMission) {
            this.missionCooldown--;
            if (this.missionCooldown <= 0) this.triggerRandomMission();
            document.getElementById('mission-hud').style.display = 'none';
        } else {
            document.getElementById('mission-hud').style.display = 'block';
            document.getElementById('mission-title').innerText = this.currentMission.title;
            document.getElementById('mission-timer').innerText = `Tempo: ${Math.ceil(this.missionTimer/60)}s`;
            
            this.missionTimer--;

            // Condi√ß√£o Especial: Pacifista
            if (this.currentMission.id === 'pacifist' && this.input.mouseDown) {
                this.showToast("Miss√£o Falhou!");
                this.currentMission = null;
                this.missionCooldown = 400;
            }

            if (this.missionTimer <= 0) {
                if(this.currentMission.id === 'pacifist') {
                    this.player.xp += 200;
                    this.showToast("Sucesso! +200 XP");
                }
                this.currentMission = null;
                this.missionCooldown = 600; // Espera para pr√≥xima
                this.statMultipliers = { enemySpeed: 1, enemyHealth: 1, xpGain: 1, playerDamage: 1 };
            }
        }
    }

    loop() {
        if (!this.isRunning || this.isPaused) return;

        // Limpeza e Fundo
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        if (assets.bgTile.complete) {
            const ptrn = ctx.createPattern(assets.bgTile, 'repeat');
            ctx.fillStyle = ptrn; ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        this.updateMissions();
        this.updatePlayer();
        this.updateEnemies();
        this.updateBullets();
        this.updateDrops();

        updateUI();
        requestAnimationFrame(() => this.loop());
    }

    updatePlayer() {
        const p = this.player;
        if (this.input.keys['w']) p.y -= p.speed;
        if (this.input.keys['s']) p.y += p.speed;
        if (this.input.keys['a']) p.x -= p.speed;
        if (this.input.keys['d']) p.x += p.speed;

        if (p.cooldown > 0) p.cooldown--;
        
        let actualFireRate = p.fireRate;
        if(this.currentMission?.id === 'frenzy') actualFireRate = 2;

        if (this.input.mouseDown && p.cooldown <= 0) {
            for(let i=0; i<p.multiShot; i++) {
                const angle = Math.atan2(this.input.mouseY - p.y, this.input.mouseX - p.x) + (i - (p.multiShot-1)/2) * 0.1;
                this.bullets.push({ x: p.x, y: p.y, vx: Math.cos(angle)*10, vy: Math.sin(angle)*10, damage: p.damage * this.statMultipliers.playerDamage, type: 'player' });
            }
            p.cooldown = actualFireRate;
        }
        ctx.drawImage(assets.player, p.x-p.size, p.y-p.size, p.size*2, p.size*2);
    }

    updateEnemies() {
        if (Math.random() < 0.02) {
            const x = Math.random() < 0.5 ? -50 : canvas.width + 50;
            const y = Math.random() * canvas.height;
            let type = 'basic';
            if(this.currentMission?.id === 'tank_inv') type = 'tank';
            else if(this.currentMission?.id === 'swarm') type = 'fast';
            
            this.enemies.push({ x, y, type, hp: 20 * this.statMultipliers.enemyHealth, speed: (type === 'fast' ? 4 : 2) * this.statMultipliers.enemySpeed });
        }

        for (let i = this.enemies.length-1; i >= 0; i--) {
            const e = this.enemies[i];
            const angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
            e.x += Math.cos(angle) * e.speed;
            e.y += Math.sin(angle) * e.speed;

            let img = assets.enemyBasic;
            if(e.type === 'tank') img = assets.enemyTank;
            if(e.type === 'fast') img = assets.enemyFast;
            ctx.drawImage(img, e.x-25, e.y-25, 50, 50);

            // Dano por contato
            const dist = Math.hypot(this.player.x - e.x, this.player.y - e.y);
            if (dist < 40) {
                this.player.hp -= (this.currentMission?.id === 'glass' ? 100 : 10);
                this.enemies.splice(i, 1);
                if(this.player.hp <= 0) location.reload();
            }
        }
    }

    updateBullets() {
        for(let i=this.bullets.length-1; i>=0; i--) {
            const b = this.bullets[i];
            b.x += b.vx; b.y += b.vy;
            ctx.drawImage(assets.bullet, b.x-5, b.y-5, 10, 10);

            for(let j=this.enemies.length-1; j>=0; j--) {
                const e = this.enemies[j];
                if(Math.hypot(b.x - e.x, b.y - e.y) < 30) {
                    e.hp -= b.damage;
                    this.bullets.splice(i, 1);
                    if(e.hp <= 0) {
                        this.enemies.splice(j, 1);
                        this.player.xp += 15 * this.statMultipliers.xpGain;
                        if(this.player.xp >= this.player.xpToNext) this.levelUp();
                    }
                    break;
                }
            }
        }
    }

    updateDrops() {
        for(let i=this.drops.length-1; i>=0; i--) {
            const d = this.drops[i];
            ctx.drawImage(assets.ammo, d.x-15, d.y-15, 30, 30);
            if(Math.hypot(this.player.x - d.x, this.player.y - d.y) < 30) {
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + 25);
                this.drops.splice(i, 1);
            }
        }
    }

    levelUp() {
        this.player.level++;
        this.player.xp = 0;
        this.player.skillPoints++;
        this.showToast("Level Up! Pressione para abrir a loja");
        this.toggleShop(true);
    }

    showToast(m) {
        const t = document.createElement('div'); t.className = 'ach-toast'; t.innerText = m;
        document.getElementById('achievement-container').appendChild(t);
        setTimeout(() => t.remove(), 3000);
    }
}

const game = new Game();
function updateUI() {
    document.getElementById('hud-level').innerText = game.player.level;
    document.getElementById('hud-xp').innerText = Math.floor(game.player.xp);
    document.getElementById('hud-next-xp').innerText = game.player.xpToNext;
    document.getElementById('hud-hp').innerText = Math.floor(game.player.hp);
    document.getElementById('hud-sp').innerText = game.player.skillPoints;
}
</script>
</body>
</html>

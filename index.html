<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Robot Survivors - Expansion</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; color: #00d2ff; font-family: 'Courier New', monospace; user-select: none; }
        canvas { display: block; filter: saturate(1.5) contrast(1.2); }
        
        #ui-layer { position: absolute; top: 20px; left: 20px; pointer-events: none; z-index: 10; }
        .stat { background: rgba(0, 10, 30, 0.8); padding: 10px; border: 1px solid #00d2ff; margin-bottom: 5px; box-shadow: 0 0 10px #00d2ff55; }
        
        #xp-bar-container { position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: #111; }
        #xp-bar-fill { height: 100%; width: 0%; background: linear-gradient(90deg, #00d2ff, #00ff88); box-shadow: 0 0 15px #00d2ff; }

        #biome-announcement { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); font-size: 3rem; text-align: center; pointer-events: none; opacity: 0; transition: 2s; z-index: 5; }

        #overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; display: none; }
        #card-container { display: flex; gap: 15px; perspective: 1000px; flex-wrap: wrap; justify-content: center; max-width: 90%; }
        .card { 
            width: 180px; height: 260px; background: #050505; border: 2px solid #00d2ff; 
            border-radius: 12px; padding: 15px; cursor: pointer; transition: 0.3s;
            display: flex; flex-direction: column; align-items: center; text-align: center;
        }
        .card:hover { transform: scale(1.05); background: #001a33; box-shadow: 0 0 30px #00d2ff88; }
        .card.rare { border-color: #00ff88; }
        .card.epic { border-color: #ff00ff; }
        .card.legendary { border-color: #ffd700; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 10px #ffd700; } 50% { box-shadow: 0 0 30px #ffd700; } 100% { box-shadow: 0 0 10px #ffd700; } }
        
        .card h3 { color: #fff; margin-bottom: 10px; font-size: 1rem; }
        .card p { color: #888; font-size: 0.8rem; }
        .card .rarity { font-size: 0.7rem; margin-top: auto; font-weight: bold; }
    </style>
</head>
<body>

    <div id="xp-bar-container"><div id="xp-bar-fill"></div></div>
    <div id="biome-announcement" class="glitch-text">BIOMA: SETOR URBANO</div>

    <div id="ui-layer">
        <div class="stat">BIOMA: <span id="biome-name">CIDADE NEON</span></div>
        <div class="stat">WAVE: <span id="wave-count">1</span></div>
        <div class="stat">HP: <span id="hp-count">100</span></div>
        <div class="stat">KILLS: <span id="kill-count">0</span></div>
    </div>

    <div id="overlay">
        <h1 style="color: #fff;">UPGRADE DE SISTEMA</h1>
        <div id="card-container"></div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Assets Placeholder (Simulando imagens com cores caso não carreguem)
const assets = { player: new Image(), enemy: new Image(), boss: new Image() };
assets.player.src = 'assets/player.png';
assets.enemy.src = 'assets/enemy_robot.png';
assets.boss.src = 'assets/boss_robot.png';

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

const game = {
    running: true, paused: false, wave: 1, kills: 0, shake: 0,
    enemies: [], bullets: [], 
    bossActive: false,
    biome: 0,
    biomes: [
        { name: "CIDADE NEON", color: "#001122", boss: "MEGA-BOT V1" },
        { name: "FUNDIÇÃO DE SUCATA", color: "#221100", boss: "TRITURADOR" },
        { name: "NÚCLEO ELÉTRICO", color: "#110022", boss: "VOLT-DRAGON" },
        { name: "VAZIO BINÁRIO", color: "#050505", boss: "SYSTEM ERROR" }
    ],
    upgrades: [
        { id: 'dmg', name: 'Servo-Motores', desc: '+20% de Dano', rarity: 'Comum' },
        { id: 'fr', name: 'Overclocking', desc: '+15% Vel. Ataque', rarity: 'Comum' },
        { id: 'speed', name: 'Propulsores', desc: '+10% Vel. Movimento', rarity: 'Comum' },
        { id: 'magnet', name: 'Ímã de Sucata', desc: '+50% Alcance de Coleta', rarity: 'Raro' },
        { id: 'hp_max', name: 'Blindagem Reforçada', desc: '+25 HP Máximo', rarity: 'Raro' },
        { id: 'regen', name: 'Nano-Reparo', desc: 'Regenera 1HP por seg.', rarity: 'Raro' },
        { id: 'pierce', name: 'Munição AP', desc: 'Balas atravessam +1 inimigo', rarity: 'Épico' },
        { id: 'multishot', name: 'Módulo Duplo', desc: '+1 Projétil disparado', rarity: 'Épico' },
        { id: 'crit', name: 'Mira Laser', desc: '+20% Chance de Crítico', rarity: 'Raro' },
        { id: 'nova', name: 'Pulso de Choque', desc: 'Libera onda de dano ao levar hit', rarity: 'Épico' },
        { id: 'life_steal', name: 'Sifão de Energia', desc: 'Cura ao destruir inimigos', rarity: 'Lendário' },
        { id: 'drone', name: 'Drone de Suporte', desc: 'Um drone que atira sozinho', rarity: 'Lendário' }
    ]
};

const player = {
    x: 0, y: 0, hp: 100, maxHp: 100, xp: 0, nextXp: 50, lvl: 1,
    speed: 4, dashCd: 0, dashMaxCd: 100, iFrames: 0,
    stats: { dmg: 1, fr: 30, magnet: 100, pierce: 0, multi: 1, regen: 0, crit: 0.1, lifeSteal: 0 }
};

const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

function spawnEnemy(isBoss = false) {
    const angle = Math.random() * Math.PI * 2;
    const dist = canvas.width * 0.6;
    const enemy = {
        x: player.x + Math.cos(angle) * dist,
        y: player.y + Math.sin(angle) * dist,
        hp: isBoss ? 500 * (game.biome + 1) : 20 + (game.wave * 5),
        maxHp: isBoss ? 500 * (game.biome + 1) : 20 + (game.wave * 5),
        speed: isBoss ? 1 : 1.5 + (Math.random() * 0.5),
        size: isBoss ? 80 : 25,
        isBoss: isBoss
    };
    game.enemies.push(enemy);
    if(isBoss) game.bossActive = true;
}

function checkWave() {
    if (game.kills >= game.wave * 20 && !game.bossActive) {
        if (game.wave % 5 === 0) {
            spawnEnemy(true);
            announceBiome(`BOSS: ${game.biomes[game.biome].boss}`);
        } else {
            game.wave++;
            document.getElementById('wave-count').innerText = game.wave;
            // Muda bioma a cada 5 waves
            if (game.wave % 5 === 1 && game.wave > 1) {
                game.biome = (game.biome + 1) % game.biomes.length;
                announceBiome(game.biomes[game.biome].name);
                document.getElementById('biome-name').innerText = game.biomes[game.biome].name;
            }
        }
    }
}

function announceBiome(txt) {
    const el = document.getElementById('biome-announcement');
    el.innerText = txt;
    el.style.opacity = 1;
    setTimeout(() => el.style.opacity = 0, 3000);
}

function handleUpgrades() {
    game.paused = true;
    const overlay = document.getElementById('overlay');
    const container = document.getElementById('card-container');
    overlay.style.display = 'flex';
    container.innerHTML = '';
    
    const options = [...game.upgrades].sort(() => 0.5 - Math.random()).slice(0, 3);
    
    options.forEach(upg => {
        const card = document.createElement('div');
        card.className = `card ${upg.rarity.toLowerCase()}`;
        card.innerHTML = `<h3>${upg.name}</h3><p>${upg.desc}</p><div class="rarity">${upg.rarity}</div>`;
        card.onclick = () => {
            applyUpgrade(upg);
            overlay.style.display = 'none';
            game.paused = false;
            requestAnimationFrame(loop);
        };
        container.appendChild(card);
    });
}

function applyUpgrade(upg) {
    if (upg.id === 'dmg') player.stats.dmg += 0.2;
    if (upg.id === 'fr') player.stats.fr *= 0.8;
    if (upg.id === 'speed') player.speed *= 1.1;
    if (upg.id === 'hp_max') { player.maxHp += 25; player.hp += 25; }
    if (upg.id === 'regen') player.stats.regen += 0.1;
    if (upg.id === 'pierce') player.stats.pierce += 1;
    if (upg.id === 'multishot') player.stats.multi += 1;
    if (upg.id === 'life_steal') player.stats.lifeSteal += 2;
    
    player.xp = 0;
    player.nextXp *= 1.2;
    player.lvl++;
}

let fireTimer = 0;
function loop() {
    if (game.paused) return;

    // Fundo do Bioma
    ctx.fillStyle = game.biomes[game.biome].color;
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Player Movimentação
    if(keys['w']) player.y -= player.speed;
    if(keys['s']) player.y += player.speed;
    if(keys['a']) player.x -= player.speed;
    if(keys['d']) player.x += player.speed;
    
    // Regeneração
    if(player.hp < player.maxHp) player.hp += player.stats.regen / 60;

    // Desenha Player
    ctx.fillStyle = '#00d2ff';
    ctx.shadowBlur = 15; ctx.shadowColor = '#00d2ff';
    ctx.fillRect(player.x - 20, player.y - 20, 40, 40);
    ctx.shadowBlur = 0;

    // Atirar
    fireTimer++;
    if(fireTimer > player.stats.fr) {
        const target = game.enemies[0];
        if(target) {
            for(let i=0; i < player.stats.multi; i++) {
                const angle = Math.atan2(target.y - player.y, target.x - player.x) + (i*0.1 - (player.stats.multi*0.05));
                game.bullets.push({
                    x: player.x, y: player.y,
                    vx: Math.cos(angle) * 10, vy: Math.sin(angle) * 10,
                    dmg: 15 * player.stats.dmg, pierce: player.stats.pierce
                });
            }
        }
        fireTimer = 0;
    }

    // Processar Balas
    for(let i=game.bullets.length-1; i>=0; i--) {
        const b = game.bullets[i];
        b.x += b.vx; b.y += b.vy;
        ctx.fillStyle = '#00ff88';
        ctx.fillRect(b.x-4, b.y-4, 8, 8);

        game.enemies.forEach((en, ei) => {
            if(Math.hypot(b.x-en.x, b.y-en.y) < en.size) {
                en.hp -= b.dmg;
                if(b.pierce <= 0) game.bullets.splice(i, 1);
                else b.pierce--;

                if(en.hp <= 0) {
                    if(en.isBoss) { game.bossActive = false; game.wave++; }
                    game.enemies.splice(ei, 1);
                    game.kills++;
                    player.xp += en.isBoss ? 100 : 10;
                    player.hp = Math.min(player.maxHp, player.hp + player.stats.lifeSteal);
                    if(player.xp >= player.nextXp) handleUpgrades();
                    checkWave();
                }
            }
        });

        if(b.x < 0 || b.x > canvas.width || b.y < 0 || b.y > canvas.height) game.bullets.splice(i, 1);
    }

    // Processar Inimigos
    game.enemies.forEach((en, i) => {
        const angle = Math.atan2(player.y - en.y, player.x - en.x);
        en.x += Math.cos(angle) * en.speed;
        en.y += Math.sin(angle) * en.speed;
        
        ctx.fillStyle = en.isBoss ? '#ff0055' : '#888';
        ctx.fillRect(en.x - en.size/2, en.y - en.size/2, en.size, en.size);
        
        // HP Bar para Boss
        if(en.isBoss) {
            ctx.fillStyle = '#333'; ctx.fillRect(en.x - 40, en.y - 60, 80, 10);
            ctx.fillStyle = '#ff0055'; ctx.fillRect(en.x - 40, en.y - 60, (en.hp/en.maxHp)*80, 10);
        }

        if(Math.hypot(player.x-en.x, player.y-en.y) < en.size && player.iFrames <= 0) {
            player.hp -= en.isBoss ? 1 : 0.2;
            if(player.hp <= 0) location.reload();
        }
    });

    if(Math.random() < 0.03 && !game.bossActive) spawnEnemy();

    // UI
    document.getElementById('hp-count').innerText = Math.floor(player.hp) + "/" + player.maxHp;
    document.getElementById('kill-count').innerText = game.kills;
    document.getElementById('xp-bar-fill').style.width = (player.xp/player.nextXp)*100 + '%';

    requestAnimationFrame(loop);
}

player.x = canvas.width/2; player.y = canvas.height/2;
loop();
</script>
</body>
</html>
